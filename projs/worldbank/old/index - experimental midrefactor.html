<!DOCTYPE html>

<style>

.table-header{
	background: #333;
	color: #f2f2f2;
	text-align: center;
}

/* Fixed header and footer.
* --------------------------------------- */
#header, #footer{
	position:fixed;
	height: 50px;
	display:block;
	width: 100%;
	background: #333;
	z-index:9;
	color: #f2f2f2;

	padding-left: 15px;
}

#header{
	top:0px;
}
#footer{
	bottom:0px;
}

.query-button{
	font-size: 13px;
}
.village-pic{
	position: absolute;
}

.color-joint{
	margin: 5px;
}

.image-swatch{
	max-width: 70px;
	max-height: 100px;
}
.swatch{
	display:inline-block; 
	width:50px; 
	height:50px;
}

#test-object {
  -webkit-filter: hue-rotate(90deg) ;
}

.hist-question{
	border: grey 1px solid;
	padding: 8px;
	padding-left: 20px;
	margin: 8px;
	margin-top: 0px;
	margin-bottom: 0px;

}

.marginal{
	color: darkgrey;
	font-size: 80%;
}

body, html{
	  width: 100%;
  height: 100%;
}
.slide{
	background-color: white;
	padding: 10px;
	padding-left: 20px;
	border: rgb(200,200,200) 1px solid;

	position: relative;
	height:100%;
	width: 100%;
}

/*.inactive{
	margin-top: 100px;
	opacity: 0;

	-webkit-transition: opacity 1.5s, margin-top 1.0s;
	-moz-transition: opacity 1.5s, margin-top 1.0s;
	transition: opacity 1.5s, margin-top 1.0s;
}
*/
/*.active{
	margin-top: 10px;
	opacity: 1;
	-webkit-transition: opacity 1.5s, margin-top 1.0s;
	-moz-transition: opacity 1.5s, margin-top 1.0s;
	transition: opacity 1.5s, margin-top 1.0s;
}
*/
.alpha-label{
	background-color: rgba(50,50,50,.2);
	color: white;
	font-size: xx-large;
}

.hoverable:hover{
	border: grey 2px solid;
}
.hoverable{
	margin-top: 20px;
	margin-bottom: 20px;
	margin-right: 10px;

	width: 100px;
	display: inline-block;
	background-color: white;
/*	border: black 1px solid;
*/	text-align: center;
}

canvas{
	border: 1px black solid;
}

.summary-image{
	max-width: 250px;
	margin-left: 50px;
	float:right;
}
.glance-icon{
	margin-left: 10px;
	max-height: 150px;
	max-width: 150px;
}

.histogram-bar{
	height: 30px; 

	-webkit-user-select: none; /* Chrome/Safari */        
	-moz-user-select: none; /* Firefox */
	-ms-user-select: none; /* IE10+ */
	-o-user-select: none;
	user-select: none;

    -webkit-transition: all .5s ease;
       -moz-transition: all .5s ease;
            transition: all .5s ease;
}

.asset-icon{
	width: 40px;
	height: 40px;
}
/*.summary-image:hover{
	border: orange 3px solid;	
}
*/
p{
	font-size: 1.2em;
}
</style>

<head>
<meta charset="utf-8"> 

<title>Concepts</title>
<script src="js/jquery-2.1.1.js"></script>
<!-- <script src="js/jquery.appear.js"></script>
 -->
 <script src="js/d3.v3.js"></script>

<script src="js/underscore.js"></script>
<script src="js/underscore.string.js"></script>
<script src="js/utils.js"></script>
<script src="js/canvas-utils.js"></script>


<script type="text/javascript" src="vendors/jquery.slimscroll.min.js"></script>
<script src="vendors/jquery.easings.min.js"></script>
<script src="js/jquery.fullPage.min.js"></script>

<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/bootstrap-theme.min.css">
<link rel="stylesheet" href="css/jquery.fullPage.css">

<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="TangleKit/mootools.js"></script>

<script type="text/javascript" src="data/brains.js"></script>
<script type="text/javascript" src="data/freq_links.js"></script>

<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
</head>


<body>



<div id="header">
	<h3 style="display:inline-block;">Data for <span class="now-showing">all</span></h3>
	<h4 style="display:inline-block;">&nbsp; <span class="num-women"></span> women </h4>
	<h4 class="comparison" style="display:inline-block;">&nbsp; (vs. <a id="comparing-with-select" class="comparing-with">Nagalapuram</a> <span class="comparing-num-women"></span> women ) </h4>

</div>

<div id="queries" class="col-xs-3 " data-spy="affix" style="overflow-y:scroll; height: 100%; padding-top:60px; padding-bottom:100px;"> 
</div>


<!-- <div style="width:800px; margin: 0 auto; display: inline-block; ">
 -->
<div id="fullpage" class="col-xs-9 col-xs-offset-3 main"> 

<div class="section" id="village-scene">

<div style="position:relative; width:95%; margin: 0 auto;">
<img src="images/back.png">

<a href="#asset-slide">
<img class="village-pic" src="images/poultry.png" style="top: 40%; left: 50px; height: 10%;">
</a>

<a href="#economic">
<img class="village-pic" src="images/economy.png" style="left: 73%; top: 58%; height:30%;">
</a>

<a href="#equality">
<img class="village-pic" src="images/house.png" style="left:80%; top: 22.5%; height:30%;">
</a>

<a href="#social">
<img class="village-pic" src="images/scooter.png" style="height:18.75%; left: 62%; top: 35%;">
</a>

<a href="#technology">
<img class="village-pic" src="images/technology2.png" style="height:30%; left: 50%; top: 57.5%;">
</a>


<a href="#marriage">
<img class="village-pic" src="images/village-flowers.png" style="top:42%; width:45%; left:-5px;">
</a>


<a href="#food">
<img class="village-pic" src="images/bananatree.png" style="left:12.5%; top:25.5%; height:35%;">
</a>


<a href="#sanitation">
<img class="village-pic" src="images/toilet.png" style="top:33.75%; left:42%; height: 12.5%">
</a>

<a href="#community">
<img class="village-pic" src="images/well.png" style="top: 55%; height:40%; left:20px;">
</a>
</div>

</div>


<div class="section">
<h3>Training</h3>
<p>
This demo explores the use of color (good) and grey (bad) to give immediate valence indicators while maintaining the depth of the information presented. 
</p>

<p>
Viewers should be able to see at a glance the indicators in which they are strong or weak. The use of hue taps into the parallel abilities of the human visual system and attempts to show patchwork complexity and spark meaningful dialogue. 
</p>
<h4>Spectrum</h4>


<img class="base-image" src="images/sari.jpg" width="300px" style="display:none;">


<div id="filter-spectrum">
</div>

</div>



<div class="section">


<h3>Histogram variants</h3>

<h4>
Histogram
</h4>
<div class="option" id="hist"></div>

<h4>Bar</h4>
<div class="option" id="bar"></div>

<h4>
Symbolic histogram
</h4>
<div class="option" id="symbol-hist"></div>

<h4>
Symbolic bar
</h4>
<div class="option" id="symbol-bar"></div>

</div>

<!-- <div class="section">
<h3>Test images</h3>
<div id="test-images">
</div>
</div>
 -->



<div class="section">
<h3>Face forces</h3>

<p>
This demo shows the party with the domainant voice in household decisions. More dominant parties are represented larger. 
</p>

<div id="face-forces" style="position:relative; background-color:rgb(205,165,47); display:none;">
	<img class="woman" src="images/woman.png" style="mmargin-left: 2px;">
	<img class="man" src="images/man.png" style="margin-left: 2px;">
	<img class="family" src="images/family.png" style="margin-left: 2px;">

	<div class="lines"></div>
</div>	

<h4>Who makes the decisions?</h4>
<table id="equality-table">
</table>
</div>

<div class="section">
<h3>Well-being indicators</h3>

<p>
16 questions were selected to represent well-being across the domains of social empowerment, technical abilities, economic health, and unclassified. Each category is represented by a summary image that obeys the grey (bad) and color (good) shading. Click on a summary image to expand the category into individual indicators. 
</p>

<h4>Social</h4>
<table class="wellbeing-table" id="social-wellbeing">
</table>
</div>

<div class="section">
<h4>Community</h4>
<table class="wellbeing-table" id="community-wellbeing">
</table>
</div>

<div class="section">
<h4>Technical</h4>
<table class="wellbeing-table" id="technical-wellbeing">
</table>
</div>

<div class="section">
<h4>Health and Sanitation</h4>
<table class="wellbeing-table" id="other-wellbeing">
</table>
</div>

<div class="section">
<h4>Economic</h4>
<table class="wellbeing-table" id="economic-wellbeing">
</table>
</div>


<!-- <h3>Higher dimension visualizations</h3>
<p>
The following visualizations are more experimental in nature and may not be appropriate to this project. These visualizations sit more in the domain of attempting to compactly represent multiple indicators in a way that highlight relevant relationships between the data.
</p>
 -->

<div class="section"> <!-- id="food"-->

<h3>Diet</h3>
<div id="diet-widget" style="position:relative; display:none; width: 130px; height: 130px; background-image:url(images/bananaleaf-big.jpeg); background-size:contain; margin-right: 20px;">

	<img class="grain" src="images/rice.png" style="height: 60px; position:absolute; left: 40px; top: 30px;">

	<img class="vegetable" src="images/eggplant.png" style="position:absolute; right: 65px;">
	<img class="meat" src="images/chicken3.png" style="position:absolute; bottom:60px;">
	<img class="fruits" src="images/papaya.png" style="position:absolute; left: 65px; ">


	<div class="cost" style="position:absolute; bottom: 0px;">
	</div>
</div>

<div id="diet">
</div>
</div>


<div class="section"> <!-- id="asset-slide"-->
<h3 id="assets-text">Assets - today</h3>

<div class="asset-widget" style="display:none; position:relative; padding: 5px; margin-top: 5px; margin-bottom:5px;">
	<div>
	<img class="asset-icon poultry" src="images/poultry.png">
	<img class="asset-icon livestock" src="images/goat4.png">
	<img class="asset-icon land" src="images/grass.png">
	<img class="asset-icon house" src="images/assetshouse.png">
	</div>
	<div>
	<img class="asset-icon houseextension" src="images/houseextension.png">
	<img class="asset-icon tv" src="images/TV.png">
	<img class="asset-icon vehicles" src="images/scooter.svg">
	<img class="asset-icon electricalappliances" src="images/fridge.png">
	</div>
</div>



<div id="new">
<button onclick="$('#new').hide(); $('#old').show(); $('#assets-text').text('Assets - 5 years ago');">&lt</button>
<div id="assets"></div>
</div>

<div id="old">
<button onclick="$('#old').hide(); $('#new').show	(); $('#assets-text').text('Assets - today');">&gt</button>
<div id="assets5"></div>
</div>


</div>



<!-- <div class="section">
<h3>Color joints</h3>

<div id="color-joints">
</div>
</div>
 -->
<div class="section">

<h3>Flowers and marriage</h3>

<p>
The height of the flower corresponds to the age at marriage. The color of flower represents whether the marriage was with a blood relative (red) or not (yes). The type of flower represents whether the woman gave consent (bloomed) or not (unbloomed). The number of leaves represent the number of children in marriage. 
</p>

<p>
This multidimensional visualization may serve to visually highlight meaningful statistical relationship between parts of the data. For instance, are there many short, unbloomed flowers? Are red flowers usually consensual or not? Does consensuality increase or decrease with age?
</p>

<p>
The data shown is a randomly drawn subsection from real populations of women. Refresh the page to see different samples. 
</p>


<table>
<tr>
<td >

<!-- <button onclick="$('#flowers').empty(); make_stem_leaf_plot('#flowers', brains, 'ageatmarriage');"><img class="image-swatch" src="images/stem.png"></button><br><br>
<button onclick="$('#flowers').empty(); make_stem_leaf_plot('#flowers', brains, 'relatedtospouse');"><img class="image-swatch" src="images/blood.png"><img class="image-swatch" src="images/flower.png"></button><br><br>
<button onclick="$('#flowers').empty(); make_stem_leaf_plot('#flowers', brains, 'decisionformarriage');"><div class="swatch" style="background-color:rgb(240,108,43);"></div> &nbsp;<div class="swatch" style="background-color:rgb(240,237,43);"></div></button>
 -->
</td>
<td style="border-left: 2px solid black; margin: 2px;">
	<div id="flowers" style="background-color:white;"></div>
</td>
</tr>
</table>
</div>

<!-- <h3>Chord Diagram</h3>
<div id="raychart" style="position:relative">
	<canvas width="500px" height="500px"></canvas>
</div>
 -->

<!-- <div class="section">
<h3>Ray Chart</h3>

<p>
This is a first prototype of a ray chart, a means of representing interrelationships between probably linked groups. The ray chart attempts to be similar to the flower diagram in showing interesting relationships between groups, but in a more generic form factor. 
</p>

<p>Hover over a category to see strength of linkages with all other data,  conditioned upon the hovered entity being true. 
</p>


<div id="container" style="position:relative; background-color:white; display: inline-block;">
	<canvas width="680px" height="500px"></canvas>
	<div id="industry" style="position:absolute; top: 400px; left: 50px; "></div>
	<div id="industry-bar" style="position:absolute; top: 400px; left: 50px; "></div>

	<div id="income" style="position:absolute; top: 0px; left: 20px; width: 100px;"></div>
	<div id="income-bar" style="position:absolute; top: 0px; left: 20px; width: 100px;"></div>

	<div id="education" style="position:absolute; top:0px; left: 550px; width: 140px;"></div>
	<div id="education-bar" style="position:absolute; top:0px; left: 550px; width: 140px;"></div>

</div>

</div>
 -->

</div> <!-- end main div-->
</body>

<script>


var filter_images_dict = {
	'computerusage': 'computerusage.JPG',
	'politicsinvolvement': 'woman_at_mic.jpg', //'womanspeaking.JPG',
	'treatmentofselfifill': 'doctor.JPG',
	'problemsolvingwithincbo': 'circle_meeting.jpg', //'circleofwomen.JPG',
	'defeacation': 'woman_toilet.jpg',
	'sanitarynapkins': 'whisper2.jpg',
	'mobilephoneusage': 'womancell.jpg',
	'outsideemployment': 'businesswoman.jpg',
	'cant_text_read': 'redphone.jpg',
	'personalmobilephone': 'colorful_phone.jpg',
	'vote': 'votercard.jpg',
	'socialissuesdemonstration': 'demonstration_hands.jpg', //'demonstration.JPG',
	'newclothes': 'brightclothes.jpg',
	'numberoftimesadaytoeat': 'bananleaffood.jpeg',
	'visitingparentshouse': 'couplehouse.jpg',
	'loansdecisionmaker': 'womanbank.jpg',
	'outsideemployment': 'walkinghandbag.jpg',		
}


var orderings = {
	'visitingparentshouse': ['Self', 'Husband', 'Family members'],				
	'mobilephoneusage': ['Yes', 'Somewhat', 'No'],
	'loansdecisionmaker': ['Both', 'Self', 'Husband', 'Family members'],
	'treatmentofselfifill' : ['Private hospital', 'Government hospital', 'Medical shop', 'Own treatment', ],
	'numberoftimesadaytoeat' : ['Thrice a day', 'Twice a day', 'Once a day', ],
	'vegetablecost' : ['Above Rs. 1500', 'Rs. 1001 - Rs. 1500', 'Rs. 500 - Rs. 1000', 'Less than Rs. 500',], 
	'fruitcost' : ['Above Rs. 1500', 'Rs. 1001 - Rs. 1500', 'Rs. 500 - Rs. 1000', 'Less than Rs. 500',], 
	'meatcost' : ['Above Rs. 1500', 'Rs. 1001 - Rs. 1500', 'Rs. 500 - Rs. 1000', 'Less than Rs. 500',], 
	'vegetableconsumption' : ['Daily', '2-3 times a per week', 'Weekly', '2-3 times per month', 'Monthly', ],
	'fruitsconsumption' : ['Daily', '2-3 times a per week', 'Weekly', '2-3 times per month', 'Monthly', ],
	'sanitarynapkins': ['Yes', 'No', "Don't know what a napkin is", ],
//	'newclothes': ['Once a month', 'Once in three months', 'Once in six months', 'Festival times', 'Once a year', ],
//	'newclothes': ['Once a month', 'Once in three months', 'Once in six months', 'Once a year', ],
	'newclothes': ['Once in three months', 'Once in six months', 'Once a year', ],

	'defeacation': ['Private toilet', 'Public toilet', 'Outside'],
	'ageatmarriage': ['Below 15', '15 to 17 years', '17 to 19 years', '19 to 21 years', '21 and above'].reverse(),

// others used just for the first item --> to calculate the index
	'decisiononnumberofchildren': ['Self'],
	'clothesdecisionmaker': ['NONE'], 
	'childreneducationandmarriage': ['My opinion is accepted'],
	'relatedtospouse': ['No'],

};


$('#fullpage').fullpage({
//				autoScrolling: false,
				scrollOverflow: true,
	anchors: ['village-scene', 'training', 'histogram-variants', 'equality', 'social', 'community', 'technology', 'sanitation', 'economic', 'food', 'asset-slide',  'marriage', 'lastPage'],
	loopBottom: true,
	resize: true,
});



$('.village-pic').mouseenter(function(){
	$(this).height($(this).height()*1.1);
});

$('.village-pic').mouseleave(function(){
	$(this).height($(this).height()*10/11);
});

var brains = _.clone(full_brains);
$('.num-women').text(full_brains.length);


$('#comparing-with-select').click(function(){
	// grab the other things worth comparing with
	var comparators = get_comparators(get_village());
	console.log('comparators length ' + comparators.length);

	// add each of them into a dropdown
	var $dropdown = $('<select />');
	comparators.forEach(function(comparator){
		var $link = $('<option />', {value: comparator, text: comparator}).appendTo($dropdown);
	});

	$dropdown.change(function(){
		var comparing_with = $(this).val();
		$('#comparing-with-select').empty();
		$('#comparing-with-select').html('<a>' + comparing_with + '</a>');

		update_state(get_level(), get_village(), comparing_with);
		viz();
		update_state(get_level(), get_village(), comparing_with);

	});

	$(this).empty();
	$(this).html($dropdown);

});

function get_level(){
	return $('.now-showing').data('level');
}

// make the hierarchy
var hierarchy;
var clusters;

// the separator used for making tuples
var sep = '!!!!';


function make_hierarchy(){
	var fields = ['habitationname', 'panchayatname', 'clustername',	'blockname'];

	// gives the next immediately bigger one
	hierarchy = {};

	// take brains and figure out 
	brains.forEach(function(datum){
		for (var i=0; i<fields.length-1; i++){
			var field = fields[i];
			var superfield = fields[i+1];

			// create unique field values
			var field_value = datum[field] + sep + field;
			var superfield_value = datum[superfield] + sep + superfield;

			hierarchy[field_value] = superfield_value;

		}
	});

	// get the clusters, what else was grouped into the same superfield
	clusters = {};

	var pairs = _.pairs(hierarchy);
	pairs.forEach(function(pair){
		var lower = pair[0];
		var upper = pair[1];

		if (_.has(clusters, upper)){
			if (clusters[upper].indexOf(lower) == -1){
				clusters[upper].push(lower);
			}
		}else{
			clusters[upper] = [lower, ];
		}
	});
}
make_hierarchy();


function get_similar(current){
	if (current == 'all'){
		// what to recommend??
		return [];
	}	

	// get copy of the similar array
	var similar = clusters[get_upper(current)].slice(0);

	var ind = similar.indexOf(current);
	similar.splice(ind, 1);
	return similar;
}

function get_comparators(current){
	if (current == 'all'){
		// what to recommend??
		return [];
	}	

	var similar = get_similar(get_village());
	similar.push(get_upper(current));
	return similar;
}

function get_upper(current){
	return hierarchy[current];
}

function to_tuple(str_mess){
	return str_mess.split(sep);
}

function to_tuplestr(tuple){
	return tuple.join(sep);
}

function get_village(){
	return $('.now-showing').first().text();
}

function get_section_index(){
	// for each section of the village scene
	var sections = {
		'social': ['visitingparentshouse', 'loansdecisionmaker', 'outsideemployment'],
		'equality': ['decisiononnumberofchildren', 'visitingparentshouse', 'childreneducationandmarriage', 'clothesdecisionmaker'],
		'community': ['respectstatusafterjoiningcbo', 'vote', 'socialissuesdemonstration', 'problemsolvingwithincbo', 'politicsinvolvement'],
		'technical': ['computerusage', 'mobilephoneusage',],
		'economic': ['vegetablecost', 'fruitcost', 'meatcost', ],
		'marriage' : ['ageatmarriage', 'decisionformarriage', 'relatedtospouse',],
		'diet': ['lastpersontoeatsenough'],
		'sanitation': ['defeacation', 'sanitarynapkins'],
		'assets' : ['land', 'house', 'livestock', 'poultry', 'tv', 'vehicles', 'electricalappliances', 'houseextension'],
	};


	// get the ordering for each question
	_.pairs(sections).forEach(function (pair){
		var section = pair[0];
		var question_ids = pair[1];

		var scores = question_ids.map(function(question_id){
			// find_goodness(question_id, current_level)
			var x = get_goodness(question_id, get_village());

//			debugger;

			// find_goodness(question_id, all_others_similar)
			var similars = get_similar(question_id, get_village());
			var similar_goodnesses = similars.map(function(similar){
				return get_goodness(question_id, similar);
			});
			var xmin = min(similar_goodnesses);
			var xmax = max(similar_goodnesses);
			var score = (x - xmin)/(xmax-xmin);

			return score;
		});

		// step 3
		var average = avg(scores);


		// step 4?? -- questionable
		// ste

	});
	// find the percentage that matches the best

}
get_section_index();

// // only first slide is active
// $('.slide').addClass('inactive');
// $('.slide').first().removeClass('inactive');

// // add appear events
// $('.slide').appear();
// $('.slide').on('appear', function(){
// 	$(this).removeClass('inactive');
// 	$(this).addClass('active');
// });


$('.village-pic').each(function(ind){
	filter_image($(this), Math.random());
});

function filter_down_brains(key, value){
	console.log('brains length prev: ' + brains.length);
	if (!isdefined(key)){
		brains = _.clone(full_brains);
	}
	else{
		brains = _.filter(full_brains, function(x){
			return x[key] === value;
		});
	}

	console.log('brains length now: ' + brains.length);
}

function get_uniques(question_id){
	var counts = _.countBy(brains, function (datum){
		return datum[question_id];
	});
	return _.keys(counts);
}


function update_state(level, value, comparing_with){
	if (value == 'all'){
		filter_down_brains();
		$('.now-showing').text('all');
		$('.now-showing').data('level', '');

		$('.num-women').text(brains.length);
		$('.comparison').hide();

		return;
	}

	filter_down_brains(level, value);

	$('.now-showing').text(value);
	$('.now-showing').data('level', level);

	$('.num-women').text(brains.length);

	// set default to the region above
	if (isdefined(comparing_with)){

	}else{
		var upper = get_upper(get_village());
		comparing_with = to_strhash(upper); 
	}

	$('.comparing-with').text(comparing_with);	
	$('.comparing-num-women').text(match_by_location(comparing_with).length);

	$('.comparison').show();
}

function make_queries(){
	$('#queries').append('<a href="#village-scene"><img src="images/village-scene.png" style="height:100px;"></a>');
	$('#queries').append('<br>');
	$('#queries').append('<br>');


	// all button
	var $button = $('<button></button>');
	$button.text('All data');
	$button.click(function(){
		update_state('all', 'all');
		viz();
		update_state('all', 'all');

	});
	$('#queries').append($button);


	var question_ids = ['habitationname', 'panchayatname',	'clustername',	'blockname'];
	question_ids.forEach(function (question_id){
		var uniques = get_uniques(question_id);

		var $container = $('<div></div>');
		$container.attr('id', question_id);
		$container.append($('<h4></h4>').text(question_id));

		uniques.forEach(function (unique){
			if (unique == 'undefined'){
				return;
			}
			var $button = $('<button class="query-button"></button>');
			$button.text(unique);
			$button.click(function(){

				update_state(question_id, unique);
				viz();
				update_state(question_id, unique);

			});

			$container.append($button);
		});

		$('#queries').append($container);
	});


}
make_queries();


//https://kuler.adobe.com/220px-50ShadesofGreyCoverArt-color-theme-3603196/
var colors = ['#192127', '#1B4063', '#2F77A1', '#C0E1E9', '#ECEEF0'];

// load images onto canvas
function make_face_diagram(field){

	var orderings_dict = {
		'visitingparentshouse': {'Self' : 'woman', 
								'Husband': 'man', 
								'Family members': 'family'},				
		'decisiononnumberofchildren': {'Self': 'woman', 
									 'Husband': 'man', 
									 'Family members': 'family'},
		'clothesdecisionmaker': {'NONE': 'woman',
					 			'1) Husband': 'man', 
								'#2) parents': 'family', 
								'#3) son / daughter': 'family', 
								'#4) family member': 'family' },
		'childreneducationandmarriage': {'My opinion is accepted': 'woman',
										 'My opinion is accepted sometimes': 'man', 
										 'My opinion is not accepted': 'man', 
										 'My opinion is totally rejected': 'man'} ,
	};


	var results = _.pluck(brains, field);
	var counts = _.countBy(results, function (answer){
		return orderings_dict[field][answer];
	});

	['woman', 'man', 'family'].forEach(function (x){
		if (! _.has(counts, x)){
			counts[x] = 0;
		}
	});
	// warning: assumes that all undefineds are due to skip patterns!
	counts['undefined'] = 0; 

	var num_responses = sum(_.values(counts));

	// scale the size of the woman's face up and down
	var $widget = $('#face-forces').clone();
	$widget.css('display', 'inline-block');

	var $imgs = $widget.children('img').each(function(ind){

		// get the data attribute 
		var repr = $(this).attr('class');
		// make the size what it should be
		var face_width = counts[repr] / num_responses * 100;
		$(this).width( face_width );			


	// draw the bar to show the dimension and lessen the tufte problem
		var $lines = $widget.last();
		$bar = $('<div style="background-color:black; display:inline-block; margin-right: 2px; margin-left: 2px;"></div>');
		$bar.width(face_width);
		$bar.height(5);
		$lines.append($bar);
	}); 


	$widget.css('padding', 4);

	return $widget;
}


function make_equality_table(){

	var long_form = {'childreneducationandmarriage' : "your child's education and marriage",
					'clothesdecisionmaker': "your clothing", 
					'decisiononnumberofchildren': "the number of children",
					'visitingparentshouse': "when to visit your parents house"};
	var images = {'childreneducationandmarriage' : 'educationmarriage.png',
		'clothesdecisionmaker': 'saree.png',
		'decisiononnumberofchildren' : 'baby.jpg',
		'visitingparentshouse' : 'bus.png', //'parentshouse.png',
	};

	var decisions = _.keys(long_form);

	var $widget = $('#equality-table');
	decisions.forEach(function(decision, ind){
		var $question = $('<h5></h5>');

		if (decision == 'childreneducationandmarriage'){
			$question.text("Is your opinion accepted related to your child's education and marriage?");
		}else{
			$question.text('Who makes the decisions regarding ' + long_form[decision] + '?');			
		}

		var $row = $('<tr></tr>');

		var $img = $('<img></img>').attr('src', 'images/' + images[decision]).height(150).css('max-width', 200);			
		$row.append($('<td style="padding-right: 30px;"></td>').append($img));

		$row.append($('<td></td>').append($question).append(make_face_diagram( decision ) ) );

		$widget.append($row);
	});
}



function make_stem_leaf_plot(selector, data, grouping_type){
	var $widget = $(selector);

	var display_width = 800;
	var flowers_per_row = 25;
	var width = display_width/flowers_per_row;

	// var flower_height = 170; // to be changed
	// var num_rows = Math.min(4, Math.floor(data.length/flowers_per_row)+1); // to be determined
	var num_flowers = 70; //flowers_per_row*num_rows;

//	$widget.width(display_width);
	// $widget.height(flower_height * num_rows);

	var ages = ['Below 15', '15 to 17 years', '17 to 19 years', '19 to 21 years', '21 and above']; //5 different heights
	//todo: could turn this into stem and leaf diagram 

	function add_flower(selector, datum){
		var $container = $('<div style="position:relative;display:inline-block;"></div>');
		$container.width(width);

		var $stem = $('<img src="images/stem4.png" style="position:absolute;">');
		var $flower = $('<img src="images/flower.png" style="position:absolute;">');

//		if (datum.relatedtospouse == 'Yes'){
		if (datum.decisionformarriage == 'No'){
			$flower.attr('src', 'images/unbloomed.png');
		}
		$flower.width(width);

		var ind = ages.indexOf(datum.ageatmarriage);
		$stem.height(lerp(ind, 0, ages.length-1, 25, 100));

		// scale the stem based on age
		// color the flower based on consent
		// $flower.css('background-color', datum.decisionformarriage == 'Yes' ? 'rgb(240,237,43)': 'rgb(240,108,43)');
		$flower.css('background-color', datum.relatedtospouse == 'Yes' ?  'rgb(240,108,43)': 'rgb(240,237,43)');

		$stem.css({bottom: 0, left: width/2+2});
		$flower.css({bottom: $stem.height()+$flower.height(), left: 0});

		$container.append($stem);
		$container.append($flower);
		$container.height($stem.height()+$flower.height() + 50);

		add_leaves(datum.numberofchildren);
		function add_leaves(num_leaves){
			range(num_leaves).forEach(function(ind){

				$leaf = $('<img src="images/leaf.png" style="position:absolute;">');
				$leaf.width(width/2.5);

				var rely = Math.floor(ind/2) * 5;
				var relx = ind % 2 == 1 ? 7 : 20;

				$leaf.css({bottom: rely + $stem.height()/3, 
						left: relx});

				ind % 2 == 1 ? rotate_image($leaf, 210) : rotate_image($leaf, 300);

				$container.append($leaf);
			});
		}

		$(selector).append($container);
	}

	// filter out undefineds
	data = _.without(data.map(function(x){
		if (isdefined(x.ageatmarriage)){
			return x;
		}
		return null;
	}), null);


	var subset = rand_sample(data, Math.min(num_flowers, data.length));

	subset.sort(function(a, b){

		if (ages.indexOf(a.ageatmarriage) < ages.indexOf(b.ageatmarriage)){
			return 1;
		}else{
			return -1;
		}

		if (a.relatedtospouse == 'Yes' && b.relatedtospouse == 'No'){
			return 1;
		}

		if (b.relatedtospouse == 'Yes' && a.relatedtospouse == 'No'){
			return -1;
		}

		if (a.decisionformarriage == 'Yes' && b.decisionformarriage == 'No'){
			return 1;
		}

		if (b.decisionformarriage == 'Yes' && a.decisionformarriage == 'No'){
			return -1;
		}

		if (a.numberofchildren < b.numberofchildren){
			return 1;
		} else{
			return -1;
		}

		return 0;
	});


	// group the subset
	var grouping_type = isdefined(grouping_type) ? grouping_type : 'ageatmarriage';
	var grouping = _.groupBy(subset, function(x){ return x[grouping_type]; });

//	grouping = _.groupBy(subset, function(x){ return x.decisionformarriage; });
	//grouping = _.groupBy(subset, function(x){ return x.relatedtospouse; });

	var most_in_bin = max(_.values(grouping).map(function(x){
		return x.length;
	}));
	var width = Math.min(display_width/most_in_bin, 30);
	var pairs = _.pairs(grouping).forEach(function(pair){
		var bin = pair[0];
		var entities = pair[1];

		var $bin = $('<div></div>');
		entities.forEach(function(x){
			add_flower($bin, x);
		});

		$widget.append($bin);
	});

}



function filter_image(selector, score){
	//	var effect = score < .5 ? 'grayscale(' + (1-score) + ')' : 'saturate(' + (score*1.2) + ')';

	//	var effect = score < .5 ? 'grayscale(' + lerp(1-score, 0.5, 1, 0, 1) + ')' : 'saturate(' + lerp(score, 0.5, 1, 1, 1.7) + ')';
	var effect = 'saturate(' + lerp(score, 0, 1, 0, 1.1) + ')';

	$(selector).css({
	   'filter'         : effect,
	   '-webkit-filter' : effect,
	   '-moz-filter'    : effect,
	   '-o-filter'      : effect,
	   '-ms-filter'     : effect
	});
};

function filter_spectrum(){
	var scores = range(0, 1, .1);

	scores.forEach(function(score){
		var $baseimage = $('.base-image').first().clone();
		$baseimage.width(100);
		$baseimage.css('display', 'inline-block');
		$('#filter-spectrum').append($baseimage);
		filter_image($baseimage, score);
	});
}
filter_spectrum();


function ray_chart(){
	var $parent = $('#raychart');
	var canvas = $parent.find('canvas')[0];
	var context = canvas.getContext("2d");

     var radius = canvas.width/2 * .8;

	function to_rad(deg){
		while (deg < 0){
			deg += 360;
		}
		while (deg > 360){
			deg -= 360;
		}
		return 2*Math.PI * deg/360;
	}
	function draw_arc(startAngle, endAngle){

	  startAngle = to_rad(startAngle);
	  endAngle = to_rad(endAngle);
//	  console.log('start ' + startAngle + ' end ' + endAngle);

	  var x = canvas.width / 2;
      var y = canvas.height / 2;

      context.beginPath();
      context.arc(x, y, radius, endAngle, startAngle, true);
      context.lineWidth = 25;

      // line color
      context.strokeStyle = 'black';
      context.stroke();
	}

	function angle_to_pt(angle){
		var radius = 10;
		var rads = to_rad(-angle);
		var x = radius*Math.cos(rads);
		var y = radius*Math.sin(rads); 

		return [canvas.width/2 + x, canvas.height/2 - y + canvas.height];
	}

	function draw_counter_arc(startAngle, endAngle){
      context.beginPath();

      var startpt = angle_to_pt(startAngle);
      var endpt = angle_to_pt(endAngle);

      context.moveTo(startpt[0], startpt[1]);
      context.quadraticCurveTo(288, 0, endpt[0], endpt[1]);
      context.lineWidth = 10;

      // line color
      context.strokeStyle = 'green';
      context.stroke();
	}


	var width = 500;
	var height = 500;

	var labels = {	'income' : ['<1000', '1000-3000', '3000-5000', '>5000'],
					'industry' : ['agriculture', 'dairy', 'poultry', 'self-employment', 'wage', 'salaried'],
					'education' : ['elementary', 'middle', 'high school', 'college']
				};

	var weights;

	var angles = {};

	var label_names = _.keys(labels);
	label_names.forEach(function(label_name, ind){
		var values = labels[label_name];

		var weights = values.map(function(){
			return Math.random();
		});
		var normed_weights = normalize_weights(weights);

		var spacer = 5;
		var low = ind*120 + spacer; 
		var high = (ind+1)*120 - spacer;
		var span = high - low;


		var pixel_spans = normed_weights.map(function(weight){
			return weight * span;
		});


		var angle_spans = [];

		pixel_spans.forEach(function(span, ind){
			var begin = sum(pixel_spans.slice(0, ind));
			var pad = .5;

			if (span > 2*pad){
				var angle_start = low+begin+pad;
				var angle_end = low+begin+span-pad;
//				draw_arc(angle_start, angle_end);
draw_arc(0, 30);
draw_counter_arc(0, 30);

				angle_spans.push([angle_start, angle_end]);
			}
		});

		angles[label_name] = angle_spans;

	});
	// todo: put in the symbol for each segment of the arc

	// draw ray between each segment of the arc to the next;

}
//ray_chart();



function diet_plates(data){
	// daily, weekly, monthly
	// does the last person who eats have enough to eat?

	var frequency = ['Daily', '2-3 times a per week', 'Weekly', 'Monthly'];
	var money = ['Less than Rs. 500', 'Rs. 500 - Rs. 1000', 'Rs. 1001 - Rs. 1500', 'Above Rs. 1500'];

	var subset = rand_sample(data, Math.min(20, data.length));

	function get_scale_down(freq){
		var ind = frequency.indexOf(freq);
		return lerp(ind, 0, frequency.length, 1, .2);
	}

	function add_money_bags($widget, datum){
		function add_bag(bag_type, num_bags){
			range(num_bags).forEach(function(){
				// var $img = $('<img width="25px">').attr('src', 'images/money-' + bag_type +'.png');
				// $widget.children('.cost').append($img);		

				var img_src = bag_type == 'vegetable' ? 'images/rupee-symbol-white.png' : 'images/rupee-symbol.png';
				var $img = $('<img style="margin-right:1px;" width="13px">').attr('src', img_src);
				var bkg_color = '#7C15AC'; // eggplant purple
				if (bag_type == 'meat'){
					bkg_color = '#F1AB56';
				}
				if (bag_type == 'fruit'){
					bkg_color = '#F37007'; 
				}
				$img.css('background-color', bkg_color);
				$widget.children('.cost').append($img);		

			});
		}

		['vegetable', 'meat', 'fruit'].forEach(function(food_type){
			if (isdefined(datum[food_type+'cost'])){
				var ind = money.indexOf(datum[food_type+'cost']);
				add_bag(food_type, ind+1);
			}
		});

	}

	subset.forEach(function(datum){
		var $widget = $('#diet-widget').clone();
		$widget.css('display', 'inline-block');
		var $images = $widget.children('img');

		$('#diet').append($widget);

		if (datum['lastpersontoeatsenough'] == 'No'){
			//$widget.children('.grain').height(60);
			$widget.children('.grain').hide();
			$widget.children('.meat').hide();
			$widget.children('.fruits').hide();
			$widget.children('.vegetable').hide();
		}

		if (datum['meat'] == 'No'){
			$widget.children('.meat').hide();
		}

		['vegetable', 'meat', 'fruits'].forEach(function(food_type){
			var scale = get_scale_down(datum[food_type+'consumption']);
			var $entry = $widget.children('.' + food_type);

			var fruit_adj = food_type == 'fruits' ? .8 : 1;
			$entry.width(60*scale * fruit_adj);

			if (food_type == 'meat'){
				$entry.css('left', 130/2 - $entry.width()/2);
			}
			if (food_type == 'fruits'){
				$entry.css('top', 130*2/3 - $entry.height()/2);
			}
			if (food_type == 'vegetable'){
				$entry.css('top', 130/2 - $entry.height()/2);
			}
		});

		// add the money bags
		add_money_bags($widget, datum);


	});

}



glance_images = {'#technical-wellbeing' : 'tablet.jpg', 
					'#social-wellbeing': 'sari.jpg',
					'#community-wellbeing': 'community.jpg',
					'#economic-wellbeing': 'rupees2.jpg',
					'#other-wellbeing': 'sanitation.jpg',
					};
// function make_glance_images(){
// 	for (var selector in glance_images){
// 		var $img = $('<img></img>').attr('src', 'images/' + glance_images[selector])
// 			.addClass('summary-image');

// 		filter_image($img, calculate_goodness(selector)); 
// 		$(selector).find('.container').append($('<td></td>').append($img));
// 	}
// }



// assumes rank ordering 
function get_colors(weights){
	var bright = '#64d613';  //  
	var mid = '#95d16a'; // '#80db43'; 

	if (weights.length == 2){
		return [bright, 'grey'];
	}
	if (weights.length == 3){
		return [bright, 'lightgray', 'gray'];
	}

	// else, return spectrum
	if (weights.length < 6){
		return [bright, mid, 'lightgray', 'gray', 'black'];			
	}

	return [bright, mid, 'lightgray', 'silver', 'gray', 'black'];		
}


function symbol_histogram(selector, data, variant){
	if (selector in glance_images){
		variant = 'symbol-hist';
	}

	var $widget = $('<td class="hist-question"></td>');

	if (isdefined(data.question_id)){
		$widget.attr('id', data.question_id);
	}
	var colors =  isdefined(data.colors)? data.colors: get_colors(data.weights);

	var $title = $('<div>'+ data.question+'</div>');
	$widget.append($title);

	var weights = normalize_weights(data.weights);
	weights.forEach(function (weight, ind){

		if (variant == 'symbol-hist'){
			var $align = $('<tr></tr>');
			var $sym = $('<img>');
			$sym.attr('src', data.symbols[ind]);
			$sym.height(40).width(40);
			$widget.append( $align.append(  $('<td></td>').append($sym) )) ;
		}


		var $bar = $('<div class="histogram-bar" style="color:white; display:inline-block; overflow:hidden; font-weight: bolder; padding-left: 2px; text-shadow: black 0.1em 0.1em 0.2em; "></div>');
		var scale_factor = 400;
		$bar.width(weight * scale_factor);
		$bar.css('background-color', colors[ind]);

		var $overflow = $('<div class="overflow" style="position:absolute; left:0px; top: 0px; font-weight: bolder; color: white; padding-left: 2px; text-shadow: black 0.08em 0.08em 0.1em;"></div>');
		$overflow.text(data.labels[ind]);
		$overflow.width(scale_factor);

		if (variant != 'symbol-hist'){
			$bar.text(data.labels[ind]);
		}
	
		if (variant === 'symbol-bar' || variant === 'blowup-bar'){

			if (weight * scale_factor > 30){
				$bar.css('background-image', "url('" + data.symbols[ind] + "')");
				$bar.css('background-size', '30px 30px');
			} 
		}

		if (variant == 'symbol-hist'){
			var $cell = $('<td style="position:relative;"></td>');
			$cell.append($bar);
			$cell.append($overflow);
			$widget.append($align.append($cell));
		}else{
			$widget.append($bar);					
		}

		if (variant === 'hist'){
			$widget.append('<br>');			
		}
	});

	var $row = $('<tr></tr>');
	$row.append($widget);

	if (isdefined(glance_images[selector])){
		function make_glance_image(score){
			var $img = $('<img class="glance-icon"></img>');
			var img_src = isdefined(data.filter_image) ? data.filter_image : glance_images[selector];
			$img.attr('src', 'images/' + img_src);
			// 0th item may not be the good one, if everyone answers the same
			filter_image($img, score);  
			return $img;		
		}

		$row.append($('<td></td>').append(make_glance_image(weights[0])));

		// todo: how to get the value for the other one
		var comparison_goodness = get_goodness(data.question_id, $('.comparing-with').first().text());
		$row.append($('<td class="comparison"></td>').append(make_glance_image(comparison_goodness)));

	}

	if (selector in glance_images){
		$(selector + ' tr').first().append($row);
	}else{
		$(selector).append($row);
	}

}

////////////// experimental section
symbol_histogram('#bar', {
		question: "Who decides visits to your parents' home?",
		labels: ['Self', 'Husband', 'Family'],
		weights: [949, 568, 42],
		choice: 0,
		symbols: ['images/woman.png', 'images/husband.png', 'images/family.png'],
	});

symbol_histogram('#hist', {
		question: "Who decides visits to your parents' home?",
		labels: ['Self', 'Husband', 'Family'],
		weights: [949, 568, 42],
		choice: 0,
		symbols: ['images/woman.png', 'images/husband.png', 'images/family.png'],
	}, 'hist');


symbol_histogram('#symbol-hist', {
		question: "Who decides visits to your parents' home?",
		labels: ['Self', 'Husband', 'Family'],
		weights: [949, 568, 42],
		choice: 0,
		symbols: ['images/woman.png', 'images/man.png', 'images/family.png'],
	}, 'symbol-hist');


symbol_histogram('#symbol-bar', {
		question: "Who decides visits to your parents' home?",
		labels: ['Self', 'Husband', 'Family'],
		weights: [949, 568, 42],
		choice: 0,
		symbols: ['images/woman.png', 'images/man.png', 'images/family.png'],
	}, 'symbol-bar');


function test_filter_images(){
	function add_range(baseimage){
		var $container = $('<div></div>');

		var scores = range(0, 1, .1);
		scores.forEach(function(score){
			var $baseimage = $('<img>').attr('src', baseimage);
			$baseimage.width(80);
			$baseimage.css('display', 'inline-block');
			$container.append($baseimage);
			filter_image($baseimage, score);
		});
		return $container;

	}
	var $widget = $('#test-images');
	for (var img_name in filter_images_dict){
		$widget.append(add_range('images/' + filter_images_dict[img_name]));
		$widget.append('<br>');
	}
}
test_filter_images();

function match_by_location(tuplehash){
//	var fields = ['habitationname', 'panchayatname', 'clustername',	'blockname'];

	var tuple = tuplehash.split(sep);
	var level = tuple[1];
	var village = tuple[0];

	return _.filter(full_brains, function(x){
		return x[level] == match_by;			
	});
}

function get_goodness(question_id, match_by){
	if (match_by == 'all'){
		return 0;
	}

	function find_best_answer(question_id){
		var yes_questions =	['outsideemployment', 'respectstatusafterjoiningcbo', 'vote', 'socialissuesdemonstration', 'problemsolvingwithincbo', 'politicsinvolvement', 'computerusage', 'decisionformarriage', 'lastpersontoeatsenough', 'land', 'house', 'livestock', 'poultry', 'tv', 'vehicles', 'electricalappliances', 'houseextension'];
		if (yes_questions.indexOf(question_id) > -1){
			return 'Yes';
		}

		try{
			var best_answer = orderings[question_id][0];
			return best_answer;		
		}catch (e) {
			console.log('find_best_answer failing for ' + question_id);
			return 0;
		}
	}

	// todo: this might be slow
	var all_data = match_by_location(match_by);

	var answers = _.countBy(all_data, function(x){
		return x[question_id];
	});

	var best_answer = find_best_answer(question_id);
	var result = answers[best_answer] / sum(_.values(answers));
	return result;
}

// console.log('goodness ' + get_goodness('visitingparentshouse', 'Nagalapuram'));
// console.log('goodness ' + get_goodness('visitingparentshouse', "H3 Silamalai II"));


function make_wellbeing_histograms(){
	//'levellectionscontesting' is blank
	var categories = {
		'social':  
		['loansdecisionmaker', 'outsideemployment', ], //['visitingparentshouse',
		
		'community': 
		['respectstatusafterjoiningcbo', 'problemsolvingwithincbo', 'socialissuesdemonstration', 'vote', 'politicsinvolvement', ],

		'technical' : 
		// 'cant_text_read' is backwards
		 ['computerusage', 'personalmobilephone', 'mobilephoneusage', 'cant_text_read'], 
		
		 'economic': 
		// 'businessdevelopmenttraining' pretty sparse
		// could not find code for 'do you have all the facilities you need for your business'
//		 ['numberoftimesadaytoeat', 'vegetableconsumption', 'vegetablecost', 'fruitsconsumption', 'fruitcost', 'newclothes' ],
		 ['numberoftimesadaytoeat', 'newclothes' ],
		
		'other' : 
		['defeacation', 'sanitarynapkins'] //'treatmentofselfifill'
	};


	var pretty_question = {'visitingparentshouse': "Who decides visits to your parents' home?",
		'loansdecisionmaker': "Who makes decisions on loans and assets in your family?",
		'outsideemployment': "Does your family allow you to pursue employment outside the house?",
		'respectstatusafterjoiningcbo' : "Have you gained respect after joining a SHG/CBO?",
		'problemsolvingwithincbo' : "Have you been involved in solving problems within your SHG/CBO?", 
		'socialissuesdemonstration' : "Have you been in any demonstration on social issues?", 
		'vote' : "Do you vote?", 
		'politicsinvolvement': "Are you interested in getting involved in politics?",
		'computerusage' : "Have you used a computer?", 
		'personalmobilephone' : "Do you have a phone?", 
		'mobilephoneusage' : "Can you use a mobile phone on your own?", 
		'cant_text_read' : "Can you read and send text messages?",
		'numberoftimesadaytoeat': "How many times a day do you eat?", 
		'vegetableconsumption' : "How often do you consume vegetables?", 
		'vegetablecost' : "How much do you spend on the purchase of vegetables in a month?", 
		'fruitsconsumption' : "How often do you consume fruits?", 
		'fruitcost' : "How much do you spend on the purchase of fruits in a month?", 
		'newclothes' : "How many times a year do you purchase new clothes for yourself?",
		'defeacation' : "Where do you go to defecate?", 
		'treatmentofselfifill': "If you are ill, what is the first method of treatment that you take?", 
		'sanitarynapkins' : "Have you used sanitary napkins during your menstrual period?",		
	};

	function get_symbols(indicator, choices){
		if (choices[0] == 'Yes' && choices.length == 2){			
			return ['images/yes.png', 'images/no.png'];
		}

		if (choices[0] == 'Yes' && choices[1] == 'Somewhat'){
			return ['images/yes.png', 'images/somewhat.png', 'images/no.png'];
		}

		if (choices[0] == 'Yes' && choices[2] == "Don't know what a napkin is"){
			return ['images/yes.png', 'images/no.png', 'images/dontknow.png'];
		}

		if (choices[0] == 'Thrice a day'){
			return ['images/bananaleaf3.png', 'images/bananaleaf2.png', 'images/bananaleaf2.jpeg',];
		}

		if (choices[0] == 'Private toilet'){
			return ['images/indian-toilet.png', 'images/publictoilet.jpg', 'images/grass.png'];
		}

		if (choices[0] == 'Once in three months'){
			return ['images/saree4.png', 'images/saree2.png', 'images/saree.png'];
		}

		return choices.map(function(choice){
			if (choice == 'Both'){				
				return 'images/both.png';
			}
			else if (choice == 'Self'){
				return 'images/woman.png';
			}
			else if (choice == 'Husband'){
				return 'images/man.png';
			}
			else if (choice == 'Family members'){
				return 'images/family.png';
			}
			else{				
				return '';
			}

		});
	}

	brains = brains.map(function(datum){
		if (datum.newclothes == 'Festival times'){
			datum.newclothes = 'Once in six months'
		}

		if (datum.newclothes == 'Once a month'){
			datum.newclothes = 'Once in three months'
		}


		if (!isdefined(datum.personalmobilephone)){
			datum.personalmobilephone = 'No';
		}
		return datum;
	});


	// the data arrives and now we get to bundle it together
	// worry about performance later
	_.pairs(categories).forEach(function (pair){
		var header = pair[0];
		var question_ids = pair[1];

		question_ids.forEach(function(question_id){

			var grouping = _.groupBy(brains, function(x){ return x[question_id]; });
			var choices = _.keys(grouping); 
			var weights = _.values(grouping).map(function(arr){
				return arr.length;
			});	

			function without_ind(arr, ind){
				var initial = arr.slice(0, ind);
				if (ind+1 < arr.length){
					var rest = arr.slice(ind+1);
					extend(initial, rest);
				}
				return initial;
			}

			// remove undefined
			if (choices.indexOf('undefined') != -1){
				var ind = choices.indexOf('undefined');
				choices = _.without(choices, 'undefined');
				weights = without_ind(weights, ind); 
			}

			if (choices.indexOf('Not Applicable') != -1){
				var ind = choices.indexOf('Not Applicable');
				choices = _.without(choices, 'Not Applicable');
				weights = without_ind(weights, ind); 
			}

			// add in the other known answers
			if (question_id in orderings){
				var full_answers = orderings[question_id];
				full_answers.each(function (full_answer){
					if (choices.indexOf(full_answer) == -1){
						choices.push(full_answer);
						weights.push(0);
					}
				});
			}

			// make sure yes and no do not appear alone
			if (choices.length == 1){
				if (choices[0] == 'Yes'){
					choices.push('No');
					weights.push(0);
				}
				if (choices[0] == 'No'){
					choices.push('Yes');
					weights.push(0);
				}
			}

			// sort by ordering
			var zipped = _.zip(choices, weights);
			zipped = _.sortBy(zipped, function (zip){
				if (question_id in orderings){
					return orderings[question_id].indexOf(zip[0]);
				}
				if (zipped.length == 2){
					if (zip[0] == 'Yes'){
						return -1;
					}
					if (zip[0] == 'No'){
						return 1;
					}
				}
				return 0;
			}); //, {'num_choices': zipped.length}); //, {'question_id' : question_id, 'orderings': orderings});

			var unzipped = _.zip.apply(_, zipped);
			choices = unzipped[0];
			weights = unzipped[1];

			symbol_histogram('#'+header+'-wellbeing', {
				question_id: question_id,
				question: pretty_question[question_id],
				labels: choices, 
				weights: weights,
				choice: 0,
				symbols: get_symbols(question_id, choices),
				filter_image: filter_images_dict[question_id],
			});
		});
	});

}


function make_assets_viz(selector, data){
	var entities = ['land', 'house', 'livestock', 'poultry', 'tv', 'vehicles', 'electricalappliances', 'houseextension'];

	function get_count(arr, value){
		return sum(arr.map(function(x){
			return x === value ? 1 : 0;
		}));
	}

	function type_of_change(datum){
		var now = get_count(entities.map(function(entity){
			return datum[entity];
		}), 'Yes');
		var then = get_count(entities.map(function(entity){
			return datum[entity+'5'];
		}), 'Yes');
		return now-then;
	}

	var data = rand_sample(data, Math.min(24, data.length));

	// insert each 
	data.forEach(function(datum){
		var $widget = $('.asset-widget').first().clone();
		$widget.css('display', 'inline-block');
//		$widget.css('background-image', 'url(images/wood.jpg)');
		$widget.css('background-color', '#C78D3B');

		entities.forEach(function(entity){
			if (datum[entity] == 'No'){
				$widget.find('.' + entity).css('visibility', 'hidden'); 
			}
		});

		$(selector).append($widget);

		var $widget5 = $('.asset-widget').first().clone();
		$widget5.css('display', 'inline-block');
//		$widget5.css('background-image', 'url(images/grey-wood.jpg)');
//		$widget5.css('background-image', 'url(images/wood.jpg)');
		$widget5.css('background-color', '#c99c5c');

		entities.forEach(function(entity){
			if (datum[entity+'5'] == 'No'){
				$widget5.find('.' + entity).css('visibility', 'hidden'); 
			}
		});

		$(selector+'5').append($widget5);

		var amount = 0;
		if (type_of_change(datum) > 0){
			amount = type_of_change(datum);
			$widget.css('border', 'green solid ' + amount + 'px');			
			$widget5.css('border', 'green solid ' + amount + 'px');			
		}
		if (type_of_change(datum) < 0){
			amount = Math.abs(type_of_change(datum));
			$widget.css('border', 'red solid ' + amount + 'px');			
			$widget5.css('border', 'red solid ' + amount + 'px');			
		}

		$widget.css('margin-left', 8-amount);
		$widget.css('margin-right', 8-amount);
		$widget5.css('margin-left', 8-amount);
		$widget5.css('margin-right', 8-amount);

	});
}
$('#old').hide();


// function raychart_data(){

// 	var link_data = {}; // key that maps to other 
	
// 	Object.prototype.getdefault = function (key, def){
// 		if (!(key in this)){
// 			this[key] = def;			
// 		}
// 		return this[key];
// 	};

// 	var question_ids = ['education', 'livelihoodactivity', 'monthlyearnings'];
// 	var data = pluck(question_ids);

// 	data.forEach(function (datum){
// 		var pairs = _.pairs(datum);
// 		for (var i=0; i<pairs.length; i++){
// 			var pair = pairs[i];
// 			var others = pairs.slice(0, i);
// 			if (i < pairs.length - 1){
// 				extend(others, pairs.slice(i+1, pairs.length));
// 			}

// 			var observed = link_data.getdefault(pair, []);
// 			extend(observed, others);
// 		}

// 		// todo: not sure how to handle multiple labels
// 	});

// 	// with open('data/freq_links.js', 'w') as f:
// 	// 	max_size = max([max(x.values()) for x in links.values()])
// 	// 	f.write('max_link_size = ' + str(max_size) + ';')
// 	// 	f.write('link_data = ' + str(links) + ';')
// 	freq_links(link_data);

// }
// raychart_data();


// function freq_links(data){
// 	var $parent = $('#container');
// 	var canvas = $parent.find('canvas')[0];
// 	var context = canvas.getContext("2d");

// 	var width = 600;
// 	var height = 500;

// 	var vector_colors = ['orange', 'lightslategray', 'lightseagreen', 'orange'];


// 	// var labels = { 'education': ['Uneducated', 'Primary school', 'Middle school', 'Secondary school', 'Sr. Secondary school'],
// 	// 	'income': ['Less than Rs. 1000', 'Rs. 1000 - Rs. 3000', 'Rs. 3001 - Rs. 5000', 'Rs. 5001 - Rs. 10000', 'Above Rs. 10000'],
// 	// 	'industry': ['Salary employment', 'Dairy', 'Wage employment', 'Wage employment only', 'Agriculture'] }
// 	var labels = _.groupBy(_.pairs(_.keys(data)), function (pair){
// 		var key = pair[1];
// 		var label_name = key.split(',')[0];
// 		return label_name;
// 	});

// //	debugger;
// 	var weights;

// 	// add in labels
// 	var i=0;
// 	for (var label_name in labels){
// 		var values = labels[label_name];
// 		var $section = $($parent).find('#' + label_name);
// 		values.forEach(function(x){
// 			var x = x[1].split(',')[1];
// 			var $label = $('<span class="hoverable">' + x + '</span>');
// 			$label.css('background-color', vector_colors[i+1]);
// 			$label.css('color', 'white');
// 			$section.append($label);
// 		});
// 		i++;
// 	}

// 	function lookup_thickness(from, to){
// 		return data[from][to];
// 	}

// 	// upon hover
// 	$('.hoverable').hover(function(){
// 	 	context.clearRect(0, 0, width, height);

// 		var $hoverelt = $(this);
// 		var elt_pos = $hoverelt.position();
// 		var pelt_pos = $hoverelt.parent().position();

// 		var others = $parent.find('.hoverable').filter(function(ind, elt){
// 			return  $(elt).parent()[0] != $hoverelt.parent()[0] ;
// 		});

// 		//others.css('background-color', 'red');
// 		others.each(function(ind, other){
// 			var $other = $(other);
// 			var pos = $other.position();
// 			var ppos = $other.parent().position();

// 			// lookup the weight in the table
// 			var ydelta = 20; //$other.height()/2;
// //			console.log('parent index ' + $other.parent().index());

// 			var vector_color = vector_colors[$other.parent().index()];


// 			var raw_thickness = lookup_thickness($hoverelt.text(), $other.text());
// 			var thickness = lerp(raw_thickness, 0, max_link_size, 0, 30);

// 			draw_vector(context, vector_color, [elt_pos.left + pelt_pos.left, elt_pos.top + pelt_pos.top +ydelta], [pos.left + ppos.left, pos.top + ppos.top + ydelta] , thickness);

// 		});
// 	});	

// 	// the DOM knows each item's position
// 	// get each item's position if the item has a diff parent
// 	// get the weight


// 	// get a collection of vectors (start, end, weights)
// 	function draw_vector(context, vector_color, start, end, weight){
// 		// todo: incorporate the weight
// 		// todo: animate
// //			context.setTransform(1, 0, 0, -1, 0, height);

// 		plot_coords(context, [start, end], vector_color, weight);
// //		console.log('start ' + start[0] + ',' + start[1] + ' end ' + end);

// 		// position relative to canvas ....................................

// 	}
// }
// freq_links(link_data);


function freq_links(data){
	var $parent = $('#container')
	var canvas = $parent.find('canvas')[0];
	var context = canvas.getContext("2d");

	var width = 600;
	var height = 500;

	var vector_colors = ['orange', 'lightslategray', 'lightseagreen', 'orange'];

	var labels = { 'education': ['Uneducated', 'Primary school', 'Middle school', 'Secondary school', 'Sr. Secondary school'].reverse(),
		'income': ['Less than Rs. 1000', 'Rs. 1000 - Rs. 3000', 'Rs. 3001 - Rs. 5000', 'Rs. 5001 - Rs. 10000', 'Above Rs. 10000'].reverse(),
		'industry': ['Salary employment', 'Dairy', 'Wage employment', 'Wage employment only', 'Agriculture'] }

	var weights;

	// add in labels
	var i=0;
	for (var label_name in labels){
		var values = labels[label_name];

		var $section = $parent.children('#' + label_name);
		values.forEach(function(x){
			var $label = $('<span class="hoverable">' + x + '</span>');
			$label.css('background-color', vector_colors[i+1]);
			$label.css('color', 'white');
			//	$label.data('group', label_name);
			$section.append($label);

			// calculate the marginal
			// warning: /2 is an approximation due to incomplete data
			var marginal = Math.floor(sum(_.values(data[x]))/2);
			var left = $label.position().left;
				
			var bottom = $label.position().top + $label.height();
			var $marginal = $('<span class="marginal" style="position:absolute;">' + marginal + '</span>').css('left', left).css('top', bottom+20); //.text(marginal);
			$section.append($marginal);
		});


		var marginals = values.map(function(x){
			return Math.floor(sum(_.values(data[x]))/2);
		});

		function make_marginal_bars(weights, position){
			function is_horizontal(){
				return label_name == 'industry';
			}
			// add in visual marginals
			var $container = $('#' + label_name + '-bar'); //$('<div style="position:absolute; left:0px; top: 0px;"></div>');
			weights.forEach(function(weight){
				var $marginal_bar = $('<div style="margin: 4px;"></div>');
				$marginal_bar.css('display', is_horizontal() ? 'inline-block' : 'block');

				if (is_horizontal()){

				$marginal_bar.height(5);
				$marginal_bar.width(weight *400/sum(weights));

				}else{

				$marginal_bar.width(5);
				$marginal_bar.height(weight *400/sum(weights));
				}

				$marginal_bar.css('background-color', vector_colors[i+1]);
				$container.append($marginal_bar);	
			});

			$parent.append($container);
		}
		make_marginal_bars(marginals);

		i++;
	}

	function lookup_thickness(from, to){
		return data[from][to];
	}

	// upon hover
	$('.hoverable').hover(function(){
	 	context.clearRect(0, 0, width*2, height*2);


		var $hoverelt = $(this);
		var elt_pos = $hoverelt.position();
		var pelt_pos = $hoverelt.parent().position();

		var others = $parent.find('.hoverable').filter(function(ind, elt){
			return  $(elt).parent()[0] != $hoverelt.parent()[0] ;
		});

		//others.css('background-color', 'red');
		others.each(function(ind, other){
			var $other = $(other);
			var pos = $other.position();
			var ppos = $other.parent().position();

			// lookup the weight in the table
			var ydelta = 20; //$other.height()/2;

			var vector_color = vector_colors[$other.parent().index()];


			var raw_thickness = lookup_thickness($hoverelt.text(), $other.text());
			var thickness = lerp(raw_thickness, 0, max_link_size, 0, 30);

			// var start_x = elt_pos.left + pelt_pos.left + $hoverelt.width()/2;
			// var start_y = elt_pos.top + pelt_pos.top + ydelta + $hoverelt.height()/2;
			// var end_x = pos.left + ppos.left + $other.width()/2;
			// var end_y = pos.top + ppos.top + ydelta + $other.height()/2;
//			draw_vector(context, vector_color, [start_x, start_y], [end_x, end_y] , thickness);

			var origin = $()

			var start_x = elt_pos.left + pelt_pos.left + $hoverelt.width()/2;
			var start_y = elt_pos.top + pelt_pos.top + ydelta + $hoverelt.height()/2;
			var end_x = pos.left + ppos.left + $other.width()/2;
			var end_y = pos.top + ppos.top + ydelta + $other.height()/2;

			plot_coords(context, [start, end], vector_color, weight);

		});
	});	

	// the DOM knows each item's position
	// get each item's position if the item has a diff parent
	// get the weight


	// get a collection of vectors (start, end, weights)
	function draw_vector(context, vector_color, start, end, weight){
		// todo: incorporate the weight
		// todo: animate
//			context.setTransform(1, 0, 0, -1, 0, height);

		plot_coords(context, [start, end], vector_color, weight);
//		console.log('start ' + start[0] + ',' + start[1] + ' end ' + end);

		// position relative to canvas ....................................

	}
}

function viz(){
	$("#equality-table").empty();
	make_equality_table();

	$('#flowers').empty();
	make_stem_leaf_plot('#flowers', brains, 'ageatmarriage'); 


	$('#diet').empty();
	diet_plates(brains);

	$('.wellbeing-table').empty();
	var $container = $('<tr class="container"></tr>');
	$container.append($('<tr> <td></td>  <td class="table-header hist-question now-showing"></td> <td class="table-header hist-question comparison comparing-with"></td> </tr>'));
	$('.wellbeing-table').append($container);
	make_wellbeing_histograms();

//	make_glance_images();

	$('#assets').empty();
	$('#assets5').empty();
	make_assets_viz('#assets', brains);

	$('#color-joints').empty();
	make_color_joints(brains);

//	show_hide_comparisons();
}
viz();

//freq_links(link_data);


function make_color_joints(data){
	var max_number = 100;
	var subset = rand_sample(data, Math.min(max_number, data.length));	

	var buckets = {
	'social' : ['visitingparentshouse', 'loansdecisionmaker', 'outsideemployment'],
	'community': ['respectstatusafterjoiningcbo', 'problemsolvingwithincbo', 'socialissuesdemonstration', 'vote', 'politicsinvolvement', ] ,
	'technical': ['computerusage', 'personalmobilephone', 'mobilephoneusage', 'cant_text_read'],	
	'economic': ['numberoftimesadaytoeat', 'newclothes' ],	
	'health': ['defeacation', 'sanitarynapkins']};
	var pairs = _.pairs(buckets);

	pairs.forEach(function(pair){
		var category = pair[0];
		var question_ids = pair[1]; 	

		var question_ids_string = question_ids.join(' - ');
		$('#color-joints').append($('<h4></h4>').text(_.str.capitalize(category)));
		$('#color-joints').append($('<h5></h5>').text(question_ids_string));

		subset.forEach(function(datum){

			var $widget = $('<div class="color-joint" style="display:inline-block;"></div>');
			var is_missing_data = false;
			question_ids.forEach(function(question_id){
				
				var num_colors = $('#' + question_id).children().length - 1;
				var colors = get_colors(range(num_colors));
				var value = datum[question_id];
				var ind = $('#'+question_id).children(':contains("' + value + '")').index() - 1;

				if (ind == -2){
					console.log('question_id ' + question_id + ' value ' + value + ' triggering missing');
					is_missing_data = true;
				}			
				var $swatch = $('<div style="display:inline-block; width: 40px; height: 20px;"></div>');
				$swatch.css('background-color', colors[ind]); 
				$swatch.attr('title', datum.nameoffemalehead);
				$widget.append($swatch);
			});

			if (!is_missing_data){
				$('#color-joints').append($widget);
			}
		});
	});	
}


function init(){
	$('.comparison').hide();
}
init();


</script>

